apiVersion: v1
kind: Template
metadata:
  name: redlist-template
  annotations:
    description: "Template to deploy the red list evaluation app (web + PostGIS) on OpenShift"
parameters:
  - name: NAME
    description: Name prefix for resources
    required: true
    value: redlist
  - name: GIT_URI
    description: Git repository URL containing the Dockerfile (required for Build)
    required: false
    value: 'https://github.com/luomus/redlist_evaluation_tool.git'
  - name: CONTEXT_DIR
    description: Context directory in the repo for the Docker build
    value: '.'
  - name: POSTGRES_IMAGE
    description: PostGIS image to use for the database
    value: postgis/postgis:16-3.4
  - name: POSTGRES_USER
    description: Postgres username
    value: redlist
  - name: POSTGRES_PASSWORD
    description: Postgres password
    value: redlist
  - name: POSTGRES_DB
    description: Postgres database name
    value: redlist
  - name: VOLUME_CAPACITY
    description: PVC size for Postgres data
    value: 1Gi

objects:
  - apiVersion: image.openshift.io/v1
    kind: ImageStream
    metadata:
      name: ${NAME}

  - apiVersion: build.openshift.io/v1
    kind: Build
    metadata:
      name: ${NAME}
    spec:
      source:
        type: Git
        git:
          uri: "${GIT_URI}"
        contextDir: "${CONTEXT_DIR}"
      strategy:
        type: Docker
      output:
        to:
          kind: ImageStreamTag
          name: "${NAME}:latest"

  - apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: ${NAME}-pgdata
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: ${VOLUME_CAPACITY}

  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: ${NAME}-db
      labels:
        app: ${NAME}
        role: db
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: ${NAME}
          role: db
      template:
        metadata:
          labels:
            app: ${NAME}
            role: db
        spec:
          containers:
            - name: postgres
              image: ${POSTGRES_IMAGE}
              ports:
                - containerPort: 5432
              env:
                - name: POSTGRES_DB
                  value: "${POSTGRES_DB}"
                - name: POSTGRES_USER
                  value: "${POSTGRES_USER}"
                - name: POSTGRES_PASSWORD
                  value: "${POSTGRES_PASSWORD}"
              volumeMounts:
                - name: pgdata
                  mountPath: /var/lib/postgresql/data
          volumes:
            - name: pgdata
              persistentVolumeClaim:
                claimName: ${NAME}-pgdata

  - apiVersion: v1
    kind: Service
    metadata:
      name: ${NAME}-db
      labels:
        app: ${NAME}
        role: db
    spec:
      ports:
        - port: 5432
          targetPort: 5432
          protocol: TCP
      selector:
        app: ${NAME}
        role: db

  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: ${NAME}
      labels:
        app: ${NAME}
        role: web
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: ${NAME}
          role: web
      template:
        metadata:
          labels:
            app: ${NAME}
            role: web
          annotations:
            image.openshift.io/triggers: >-
              [{"from":{"kind":"ImageStreamTag","name":"${NAME}:latest"},"fieldPath":"spec.template.spec.containers[?(@.name==\"${NAME}\")].image"}]
        spec:
          containers:
            - name: ${NAME}
              image: ${NAME}:latest
              ports:
                - containerPort: 5000
              env:
                - name: PYTHONUNBUFFERED
                  value: "1"
                - name: DATABASE_URL
                  value: "postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${NAME}-db:5432/${POSTGRES_DB}"

  - apiVersion: v1
    kind: Service
    metadata:
      name: ${NAME}-svc
      labels:
        app: ${NAME}
        role: web
    spec:
      ports:
        - port: 5000
          targetPort: 5000
          protocol: TCP
      selector:
        app: ${NAME}
        role: web

  - apiVersion: route.openshift.io/v1
    kind: Route
    metadata:
      name: ${NAME}
      labels:
        app: ${NAME}
    spec:
      to:
        kind: Service
        name: ${NAME}-svc
      port:
        targetPort: 5000

objectsCount: 9
